<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Professional Cupping Sheet</title>
    <!-- Standalone Dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f5f5f4; 
            color: #1c1917; 
            -webkit-print-color-adjust: exact; 
            print-color-adjust: exact;
            touch-action: manipulation;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* iPhone Mini / Mobile Specific Refinements */
        @media (max-width: 400px) {
            .score-label { font-size: 0.85rem !important; flex: 1; padding-right: 0.5rem; }
            .score-control-group { gap: 0.25rem !important; }
            .score-value { font-size: 1.1rem !important; width: 2.8rem !important; }
            .control-btn { width: 2.2rem !important; height: 2.2rem !important; }
            
            .report-title { font-size: 1.25rem !important; }
            .report-card-mobile { padding: 1rem !important; border-radius: 1.5rem !important; }
            .lot-name-mobile { font-size: 1.5rem !important; }
            .score-box-mobile { padding: 0.75rem !important; min-width: 100px !important; }
            .final-score-mobile { font-size: 2.5rem !important; }
        }

        @media print { 
            .print-hidden { display: none !important; }
            body { background-color: white !important; padding: 0 !important; margin: 0 !important; }
            
            @page { 
                size: landscape; 
                margin: 1.25cm; 
            }

            .report-card { 
                border: 1px solid #eee !important;
                background-color: white !important; 
                padding: 1.5rem !important; 
                margin: 0 0 1.5cm 0 !important; 
                width: 100% !important;
                box-shadow: none !important;
                display: flex !important;
                flex-direction: row !important;
                align-items: flex-start !important;
                box-sizing: border-box !important;
                page-break-inside: avoid !important;
                break-inside: avoid !important;
            }
            
            .spider-container { width: 35% !important; padding-left: 3rem !important; border-left: 1px solid #f0f0f0 !important; }
            .notes-container { width: 65% !important; padding-right: 3rem !important; }
            .report-card:last-child { margin-bottom: 0 !important; }
        }
        
        .btn-stone-dark { background-color: #1c1917 !important; color: #ffffff !important; border-radius: 0.75rem; transition: all 0.2s; }
        .btn-stone-dark:active { transform: scale(0.96); opacity: 0.9; }
        
        .btn-stone-light { background-color: #e7e5e4 !important; color: #44403c !important; border: 1px solid #d6d3d1; border-radius: 0.75rem; transition: all 0.2s; }
        .btn-stone-light:active { transform: scale(0.92); background-color: #d6d3d1; }

        .tag-emerald { background-color: #ECFDF5; color: #047857; border: 1px solid #D1FAE5; }
        .tag-rose { background-color: #FFF1F2; color: #BE123C; border: 1px solid #FFE4E6; }

        .observation-buffer { margin-right: 5rem !important; }
        @media (max-width: 1024px) {
            .observation-buffer { margin-right: 0 !important; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const CATEGORIES = [
            { id: 'fragrance', label: 'Fragrance' },
            { id: 'aroma', label: 'Aroma' },
            { id: 'cleanCup', label: 'Clean Cup' },
            { id: 'sweetness', label: 'Sweetness' },
            { id: 'acidity', label: 'Acidity' },
            { id: 'body', label: 'Body' },
            { id: 'flavor', label: 'Flavor' },
            { id: 'aftertaste', label: 'Aftertaste' },
            { id: 'balance', label: 'Balance' },
            { id: 'consistency', label: 'Consistency' },
            { id: 'overall', label: 'Overall' },
        ];

        const RADAR_LABELS = ["Frag/Aroma", "Clean Cup", "Sweetness", "Acidity", "Body", "Flavor", "Aftertaste", "Balance", "Consistency", "Overall"];
        const INITIAL_SCORE = 8.5;
        const INCREMENT = 0.25;
        const GRAPH_FLOOR = 7.0;

        const POSITIVE_LEXICON = ["Citrus", "Orange", "Pulpy Citrus", "Red Fruit", "Brown Fruit (Raisin/Date)", "Tropical", "Berries", "Dark Berries", "Strawberry", "Blueberry", "Lychee", "Cooked Fruit", "Melon", "Stone Fruit", "Orchard Fruit (Apple, Pear)", "Grape", "Plum", "Cherry", "Dried Banana", "Tomato", "Chocolate", "Black Tea", "Wafer Cookie", "Nuts", "Hazelnut", "Molasses", "Caramel", "Browning Sugars", "Sugarcane", "Panela", "Honey", "Graham Cracker", "Nougat", "Cola", "Sweet Hay", "Vanilla", "Pipe Tobacco", "Licorice", "Floral", "Bergamot", "Hops", "Herbal", "Baking Spices", "Cinnamon", "Mint", "Good Sweetness", "Balanced", "Juicy", "Lactic", "Tartaric", "Phosphoric", "Jammy"];
        const DEFAULT_LEXICON = {
            fragAroma: [...POSITIVE_LEXICON],
            inCup: [...POSITIVE_LEXICON],
            negative: ["Phenolic", "Quaker", "Potato", "Moldy", "Baggy", "Over-roasted", "Grassy", "Fermented", "Earthy", "Rubbery", "Astringent", "Bitter", "Salt"]
        };

        const apiKey = ""; 

        const Icon = ({ name, size = 20, className = "" }) => {
            const paths = {
                coffee: <path d="M17 8h1a4 4 0 1 1 0 8h-1M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4V8zM6 2v4M10 2v4M14 2v4"/>,
                minus: <path d="M5 12h14"/>,
                plus: <path d="M12 5v14M5 12h14"/>,
                "chevron-right": <path d="m9 18 6-6-6-6"/>,
                "chevron-left": <path d="m15 18-6-6 6-6"/>,
                "settings-2": <path d="M20 7h-9M14 17H5M11 13H3M15 5v4M9 11v4M17 15v4M21 11h-4"/>,
                "edit-2": <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>,
                "clipboard-list": <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2M12 2v4M9 2h6M8 11h.01M8 16h.01M12 11h4M12 16h4"/>,
                tag: <path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2zM7 7h.01"/>,
                "edit-3": <path d="M12 20h9M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/>,
                search: <React.Fragment><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></React.Fragment>,
                "loader-2": <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/>,
                x: <path d="M18 6 6 18M6 6l12 12"/>,
                download: <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/>,
                printer: <path d="M6 9V2h12v7M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2M6 14h12v8H6z"/>,
                history: <path d="M12 8v4l3 3m6-3a9 9 0 1 1-9-9c2.5 0 4.7 1 6.3 2.7L21 6v6h-6"/>,
                save: <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2zM17 21v-8H7v8M7 3v5h8"/>,
                trash: <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2M10 11v6M14 11v6"/>,
                home: <React.Fragment><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></React.Fragment>
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {paths[name]}
                </svg>
            );
        };

        const getSmartMatch = async (userInput, officialOptions) => {
            if (!userInput || userInput.length < 3) return null;
            const sys = `Expert coffee taster. Map input to: ${JSON.stringify(officialOptions)}. Return ONLY match or "None".`;
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [{ parts: [{ text: userInput }] }], systemInstruction: { parts: [{ text: sys }] } })
                });
                const data = await res.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text?.trim();
            } catch { return "None"; }
        };

        const App = () => {
            const [appState, setAppState] = useState('setup'); 
            const [metadataOrigin, setMetadataOrigin] = useState('setup');
            const [numSamples, setNumSamples] = useState(1);
            const [activeSampleIndex, setActiveSampleIndex] = useState(0);
            const [samples, setSamples] = useState([]);
            const [lexicon, setLexicon] = useState(DEFAULT_LEXICON);
            const [sessionStartTime, setSessionStartTime] = useState(null);
            
            // Local device storage state
            const [history, setHistory] = useState([]);
            const [showSaveModal, setShowSaveModal] = useState(false);
            const [sessionName, setSessionName] = useState('');

            useEffect(() => {
                const saved = localStorage.getItem('cupping_history');
                if (saved) setHistory(JSON.parse(saved));
            }, []);

            const resetToHome = () => {
                setSamples([]);
                setSessionStartTime(null);
                setActiveSampleIndex(0);
                setAppState('setup');
            };

            const saveSessionLocal = () => {
                if (!sessionName) return;
                const newEntry = {
                    id: Date.now(),
                    name: sessionName,
                    date: new Date().toLocaleDateString(),
                    startTime: sessionStartTime,
                    samples,
                    count: samples.length
                };
                const updatedHistory = [newEntry, ...history];
                setHistory(updatedHistory);
                localStorage.setItem('cupping_history', JSON.stringify(updatedHistory));
                setShowSaveModal(false);
                setSessionName('');
            };

            const deleteSession = (id, e) => {
                e.stopPropagation();
                const updated = history.filter(h => h.id !== id);
                setHistory(updated);
                localStorage.setItem('cupping_history', JSON.stringify(updated));
            };

            const loadSession = (session) => {
                setSamples(session.samples);
                setSessionStartTime(session.startTime);
                setAppState('report');
            };

            const initializeSamples = (count) => {
                return Array.from({ length: count }, (_, i) => ({
                    id: i + 1,
                    ositoId: '',
                    lotName: '',
                    processing: 'Select One',
                    processingOther: '',
                    scores: {
                        fragrance: INITIAL_SCORE, aroma: null, cleanCup: INITIAL_SCORE, 
                        sweetness: INITIAL_SCORE, acidity: INITIAL_SCORE, body: INITIAL_SCORE, 
                        flavor: INITIAL_SCORE, aftertaste: INITIAL_SCORE, balance: INITIAL_SCORE, 
                        consistency: INITIAL_SCORE, overall: INITIAL_SCORE, defects: 0, correction: 0
                    },
                    notes: { fragAromaTags: [], inCupTags: [], negativeTags: [], otherText: '' }
                }));
            };

            const startSession = () => {
                if (!sessionStartTime) setSessionStartTime(new Date().toLocaleString());
                setSamples(initializeSamples(numSamples));
                setAppState('cupping');
            };

            const goToMetadata = (origin) => {
                if (!sessionStartTime) setSessionStartTime(new Date().toLocaleString());
                if (samples.length === 0) setSamples(initializeSamples(numSamples));
                setMetadataOrigin(origin);
                setAppState('metadata');
            };

            const updateScore = (sampleIdx, cat, delta) => {
                setSamples(prev => {
                    const n = [...prev];
                    const cur = n[sampleIdx].scores[cat] ?? (cat === 'aroma' ? 8.5 : 0);
                    let next = Math.round((cur + delta) * 4) / 4;
                    if (next < 0 && cat !== 'correction') next = 0;
                    if (next > 10 && !['defects', 'correction'].includes(cat)) next = 10;
                    n[sampleIdx].scores[cat] = next;
                    return n;
                });
            };

            const updateMetadata = (sampleIdx, field, value) => {
                setSamples(prev => {
                    const n = [...prev];
                    n[sampleIdx][field] = value;
                    return n;
                });
            };

            const toggleTag = (idx, section, tag) => {
                setSamples(prev => {
                    const n = [...prev];
                    const field = `${section}Tags`;
                    const current = n[idx].notes[field];
                    n[idx].notes[field] = current.includes(tag) ? current.filter(t => t !== tag) : [...current, tag];
                    return n;
                });
            };

            const cycleTagModifier = (idx, section, tagString) => {
                setSamples(prev => {
                    const n = [...prev];
                    const field = `${section}Tags`;
                    const tags = [...n[idx].notes[field]];
                    const tagIdx = tags.indexOf(tagString);
                    if (tagIdx === -1) return prev;
                    let baseTag = tagString.replace("Slight ", "").replace("Intense ", "");
                    let newTag = "";
                    if (tagString.startsWith("Slight ")) {
                        newTag = "Intense " + baseTag;
                    } else if (tagString.startsWith("Intense ")) {
                        newTag = baseTag;
                    } else {
                        newTag = "Slight " + baseTag;
                    }
                    tags[tagIdx] = newTag;
                    n[idx].notes[field] = tags;
                    return n;
                });
            };

            const getFragAromaAvg = (s) => (s.aroma !== null ? (s.fragrance + s.aroma) / 2 : s.fragrance);
            const calculateTotal = (sample) => {
                const s = sample.scores;
                const fragAroma = getFragAromaAvg(s);
                const others = [s.cleanCup, s.sweetness, s.acidity, s.body, s.flavor, s.aftertaste, s.balance, s.consistency, s.overall].reduce((a, b) => a + b, 0);
                const raw = fragAroma + others - s.defects + s.correction;
                return (Math.ceil(raw * 4) / 4).toFixed(2);
            };

            const downloadCSV = () => {
                const headers = ['Sample #', 'Osito ID', 'Lot Name', 'Processing', 'Fragrance', 'Aroma', 'Average', 'Clean Cup', 'Sweetness', 'Acidity', 'Body', 'Flavor', 'Aftertaste', 'Balance', 'Consistency', 'Overall', 'Defects', 'Cup Correction', 'Score', 'Frag/Aroma Notes', 'In the Cup Notes', 'Negative Notes', 'Other Notes', 'Session Start Time'];
                const rows = samples.map(s => {
                    const proc = s.processing === 'Other' ? `Other - ${s.processingOther}` : (s.processing === 'Select One' ? 'N/A' : s.processing);
                    return [s.id, `"${s.ositoId}"`, `"${s.lotName}"`, `"${proc}"`, s.scores.fragrance.toFixed(2), (s.scores.aroma || s.scores.fragrance).toFixed(2), getFragAromaAvg(s.scores).toFixed(2), s.scores.cleanCup.toFixed(2), s.scores.sweetness.toFixed(2), s.scores.acidity.toFixed(2), s.scores.body.toFixed(2), s.scores.flavor.toFixed(2), s.scores.aftertaste.toFixed(2), s.scores.balance.toFixed(2), s.scores.consistency.toFixed(2), s.scores.overall.toFixed(2), s.scores.defects.toFixed(2), s.scores.correction.toFixed(2), calculateTotal(s), `"${s.notes.fragAromaTags.join('; ')}"`, `"${s.notes.inCupTags.join('; ')}"`, `"${s.notes.negativeTags.join('; ')}"`, `"${s.notes.otherText.replace(/"/g, '""')}"`, `"${sessionStartTime}"`].join(',');
                });
                const csvContent = [headers.join(','), ...rows].join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = `Cupping_Export.csv`; a.click();
            };

            // --- VIEWS ---
            if (appState === 'setup') {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4 md:p-6 bg-stone-100">
                        <div className="max-w-md w-full bg-white rounded-[2rem] shadow-2xl p-8 md:p-10 text-center border border-stone-200">
                            <div className="inline-flex p-4 rounded-3xl bg-stone-900 text-white mb-6 md:mb-8 shadow-xl"><Icon name="coffee" size={28} /></div>
                            <h1 className="text-2xl md:text-3xl font-black text-stone-900 mb-2 tracking-tight">Cupping Lab</h1>
                            <p className="text-stone-400 font-medium mb-8 md:mb-10 text-xs uppercase tracking-widest">Select sample count to begin</p>
                            <div className="flex items-center justify-between bg-stone-100 rounded-2xl p-2 md:p-3 mb-8 md:mb-10 border border-stone-200 shadow-inner">
                                <button onClick={() => setNumSamples(Math.max(1, numSamples - 1))} className="w-12 h-12 md:w-14 md:h-14 bg-white shadow-sm flex items-center justify-center btn-stone-light"><Icon name="minus" size={18} /></button>
                                <span className="text-4xl md:text-5xl font-black text-stone-900 tabular-nums">{numSamples}</span>
                                <button onClick={() => setNumSamples(numSamples + 1)} className="w-12 h-12 md:w-14 md:h-14 bg-white shadow-sm flex items-center justify-center btn-stone-light"><Icon name="plus" size={18} /></button>
                            </div>
                            <div className="space-y-3">
                                <button onClick={startSession} className="w-full py-4 md:py-5 btn-stone-dark font-black text-base md:text-lg flex items-center justify-center gap-3 shadow-2xl">Start Session <Icon name="chevron-right" /></button>
                                <div className="grid grid-cols-2 gap-3">
                                    <button onClick={() => goToMetadata('setup')} className="py-3 md:py-4 bg-white text-stone-600 border-2 border-stone-100 rounded-2xl font-bold text-xs hover:bg-stone-50 transition-colors flex items-center justify-center gap-2"><Icon name="settings-2" size={14} /> Configure</button>
                                    <button onClick={() => setAppState('history')} className="py-3 md:py-4 bg-white text-stone-600 border-2 border-stone-100 rounded-2xl font-bold text-xs hover:bg-stone-50 transition-colors flex items-center justify-center gap-2"><Icon name="history" size={14} /> History</button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (appState === 'history') {
                return (
                    <div className="min-h-screen bg-stone-100 p-6 md:p-12">
                        <div className="max-w-4xl mx-auto space-y-8">
                            <div className="flex items-center justify-between">
                                <h1 className="text-2xl md:text-3xl font-black text-stone-900 tracking-tight">Saved Sessions</h1>
                                <button onClick={() => setAppState('setup')} className="text-stone-400 font-bold hover:text-stone-900 text-sm">Back</button>
                            </div>
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                {history.length > 0 ? history.map(item => (
                                    <div key={item.id} onClick={() => loadSession(item)} className="bg-white p-6 rounded-3xl border border-stone-200 shadow-sm cursor-pointer hover:shadow-md transition-shadow relative group">
                                        <div className="flex justify-between items-start mb-2">
                                            <span className="text-[10px] font-black text-stone-300 uppercase tracking-widest">{item.date}</span>
                                            <button onClick={(e) => deleteSession(item.id, e)} className="p-2 text-stone-200 hover:text-red-500 transition-colors"><Icon name="trash" size={14}/></button>
                                        </div>
                                        <h3 className="text-lg font-black text-stone-900 leading-tight pr-4">{item.name}</h3>
                                        <p className="text-xs font-bold text-stone-400 uppercase mt-2">{item.count} Samples</p>
                                    </div>
                                )) : (
                                    <div className="col-span-full py-20 text-center text-stone-400 font-bold italic">No sessions saved on this device.</div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            if (appState === 'metadata') {
                return (
                    <div className="min-h-screen bg-stone-100 p-4 md:p-12">
                        <div className="max-w-4xl mx-auto space-y-6 pb-32">
                            <div className="flex items-center justify-between">
                                <h1 className="text-2xl font-black text-stone-900 tracking-tight">Lot Information</h1>
                                <button onClick={() => setAppState(metadataOrigin === 'report' ? 'report' : 'setup')} className="text-stone-400 font-bold text-sm">Back</button>
                            </div>
                            {samples.map((s, idx) => (
                                <div key={idx} className="bg-white p-6 rounded-3xl border border-stone-200 shadow-sm space-y-4">
                                    <div className="flex items-center gap-3 border-b border-stone-50 pb-3"><span className="w-6 h-6 rounded-full bg-stone-900 text-white flex items-center justify-center font-black text-[10px]">#{s.id}</span><h3 className="font-black text-stone-800 uppercase tracking-widest text-[10px]">Lot Data</h3></div>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div className="space-y-1"><label className="text-[9px] font-black text-stone-400 uppercase ml-1">Osito ID</label><input value={s.ositoId} onChange={(e) => updateMetadata(idx, 'ositoId', e.target.value)} placeholder="OS-ID..." className="w-full bg-stone-50 p-3 rounded-xl border border-transparent focus:bg-white focus:border-stone-200 outline-none font-bold text-stone-800 text-sm" /></div>
                                        <div className="space-y-1"><label className="text-[9px] font-black text-stone-400 uppercase ml-1">Lot Name</label><input value={s.lotName} onChange={(e) => updateMetadata(idx, 'lotName', e.target.value)} placeholder="Lot Name..." className="w-full bg-stone-50 p-3 rounded-xl border border-transparent focus:bg-white focus:border-stone-200 outline-none font-bold text-stone-800 text-sm" /></div>
                                        <div className="space-y-1"><label className="text-[9px] font-black text-stone-400 uppercase ml-1">Processing</label><select value={s.processing} onChange={(e) => updateMetadata(idx, 'processing', e.target.value)} className="w-full bg-stone-50 p-3 rounded-xl border border-transparent focus:bg-white focus:border-stone-200 outline-none font-bold text-stone-800 text-sm"><option>Select One</option><option>Washed</option><option>Natural</option><option>Honey</option><option>Other</option></select></div>
                                    </div>
                                    {s.processing === 'Other' && (<div className="animate-in slide-in-from-top-2"><input value={s.processingOther} onChange={(e) => updateMetadata(idx, 'processingOther', e.target.value)} placeholder="Processing Details..." className="w-full bg-stone-50 p-3 rounded-xl border border-transparent focus:bg-white focus:border-stone-200 outline-none font-bold text-stone-800 text-sm" /></div>)}
                                </div>
                            ))}
                            <button onClick={() => setAppState(metadataOrigin === 'report' ? 'report' : 'cupping')} className="w-full py-5 btn-stone-dark font-black text-lg shadow-2xl fixed bottom-6 left-1/2 -translate-x-1/2 max-w-lg uppercase tracking-wider">Save Details</button>
                        </div>
                    </div>
                );
            }

            if (appState === 'report') {
                return (
                    <div className="min-h-screen bg-stone-100 p-4 md:p-8 relative">
                        {showSaveModal && (
                            <div className="fixed inset-0 z-[100] flex items-center justify-center bg-stone-900/60 backdrop-blur-sm p-6">
                                <div className="bg-white w-full max-w-sm rounded-[2rem] p-8 space-y-6 shadow-2xl animate-in fade-in zoom-in-95">
                                    <div className="text-center"><h3 className="text-xl font-black text-stone-900">Name this Session</h3><p className="text-stone-400 font-bold text-[10px] uppercase tracking-widest mt-1">To save on this device</p></div>
                                    <input value={sessionName} onChange={(e) => setSessionName(e.target.value)} placeholder="e.g. Morning QC..." className="w-full bg-stone-50 p-4 rounded-2xl border border-stone-200 outline-none font-bold text-sm" />
                                    <div className="flex flex-col gap-2"><button onClick={saveSessionLocal} className="w-full py-4 btn-stone-dark font-black text-sm uppercase tracking-widest">Save Session</button><button onClick={() => setShowSaveModal(false)} className="w-full py-2 text-stone-400 font-bold text-xs uppercase">Cancel</button></div>
                                </div>
                            </div>
                        )}
                        <div className="max-w-[1500px] mx-auto space-y-6 pb-20">
                            <header className="flex flex-wrap items-center justify-between print-hidden gap-3">
                                <div className="flex gap-2">
                                    <button onClick={resetToHome} className="flex items-center gap-2 bg-stone-100 px-4 md:px-6 py-2 rounded-xl font-bold shadow-sm border border-stone-200 text-stone-600 active:scale-95"><Icon name="home" size={16}/> <span className="hidden md:inline">Home</span></button>
                                    <button onClick={() => setAppState('cupping')} className="flex items-center gap-2 bg-white px-4 md:px-6 py-2 rounded-xl font-bold shadow-sm border border-stone-200 text-stone-600 active:scale-95"><Icon name="chevron-left" size={16}/> <span className="hidden md:inline">Back</span></button>
                                </div>
                                <div className="flex flex-wrap gap-2">
                                    <button onClick={() => setShowSaveModal(true)} className="flex items-center gap-2 bg-white px-4 py-2 rounded-xl font-bold text-blue-600 border border-blue-100 active:scale-95"><Icon name="save" size={16}/> Save</button>
                                    <button onClick={() => goToMetadata('report')} className="flex items-center gap-2 bg-white px-4 py-2 rounded-xl font-bold text-stone-600 border border-stone-200 active:scale-95"><Icon name="edit-2" size={16}/> Lots</button>
                                    <button onClick={downloadCSV} className="flex items-center gap-2 bg-stone-200 px-4 py-2 rounded-xl font-bold text-stone-800 active:scale-95"><Icon name="download" size={16}/> CSV</button>
                                    <button onClick={() => window.print()} className="flex items-center gap-2 px-6 py-2 btn-stone-dark font-bold shadow-xl active:scale-95"><Icon name="printer" size={16}/> PDF</button>
                                </div>
                            </header>

                            <div className="bg-white p-4 md:p-12 rounded-[2rem] shadow-sm border border-stone-200 print:shadow-none print:border-none print:p-0 print:bg-transparent">
                                <div className="flex justify-between items-baseline border-b-2 border-stone-50 pb-6 mb-10 print:border-stone-200">
                                    <h1 className="text-base md:text-2xl font-black text-stone-900 uppercase tracking-tight report-title">Cupping Session Summary</h1>
                                    <div className="text-right"><p className="text-[8px] md:text-[9px] font-black text-stone-300 uppercase leading-none mb-1">Started</p><p className="text-[10px] md:text-xs font-bold text-stone-400">{sessionStartTime}</p></div>
                                </div>
                                <div className="space-y-4 md:space-y-0">
                                    {samples.map((s) => (
                                        <div key={s.id} className="report-card report-card-mobile bg-white rounded-[2.5rem] p-4 md:p-10 mb-8 md:mb-12 shadow-sm border border-stone-200 print:mb-0 print:border-none print:border-b print:border-stone-100 print:rounded-none flex flex-col lg:flex-row items-stretch">
                                            <div className="notes-container flex-1 min-w-0 pr-0 lg:pr-24 space-y-6 md:space-y-10 border-r-0 lg:border-r lg:border-stone-100 print:pr-12">
                                                <div className="flex flex-col sm:flex-row items-start justify-between border-b-2 border-stone-50 pb-4 md:pb-6 gap-4">
                                                    <div className="min-w-0"><span className="text-[9px] font-black text-stone-300 uppercase tracking-widest leading-none block mb-1">Sample {s.id}</span><h2 className="text-2xl md:text-3xl font-black text-stone-900 tracking-tight leading-tight truncate overflow-visible lot-name-mobile">{s.lotName || `Lot #${s.id}`}</h2>{s.ositoId && <span className="text-[9px] font-black bg-stone-900 text-white px-2 py-0.5 rounded tracking-tighter mt-1 inline-block uppercase">{s.ositoId}</span>}</div>
                                                    <div className="text-right px-4 md:px-8 py-3 md:py-4 bg-stone-900 text-white rounded-2xl shadow-lg shrink-0 w-full sm:w-auto score-box-mobile"><p className="text-[8px] md:text-[10px] font-bold text-stone-400 uppercase tracking-widest mb-1">Final Score</p><p className="text-3xl md:text-4xl font-black tabular-nums leading-none final-score-mobile">{calculateTotal(s)}</p></div>
                                                </div>
                                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-x-12 gap-y-6 md:gap-y-10 print:gap-x-12 print:gap-y-6">
                                                    <ReportTags label="Fragrance / Aroma" tags={s.notes.fragAromaTags} color="emerald" alwaysShow={true} />
                                                    <ReportTags label="In Cup / Flavor" tags={s.notes.inCupTags} color="emerald" alwaysShow={true} />
                                                    <ReportTags label="Negative Factors" tags={s.notes.negativeTags} color="rose" alwaysShow={true} />
                                                    <div className="space-y-2 observation-buffer"><p className="text-[9px] font-black text-stone-300 uppercase tracking-widest leading-none block">Observations</p><div className={`text-[11px] md:text-[13px] italic text-stone-600 leading-relaxed bg-stone-50 p-3 md:p-4 rounded-2xl border border-stone-100 whitespace-pre-wrap shadow-inner min-h-[60px] print:bg-white print:p-2 print:border-stone-50`}>{s.notes.otherText || "No additional notes recorded."}</div></div>
                                                </div>
                                            </div>
                                            <div className="spider-container shrink-0 flex items-center justify-center pl-0 lg:pl-16 mt-6 lg:mt-0 bg-white print:pl-12 print:bg-transparent"><SpiderGraph scores={s.scores} size={280} isReport={true} /></div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            const currentSample = samples[activeSampleIndex];

            return (
                <div className="min-h-screen bg-stone-50 text-stone-800 pb-40">
                    <div className="sticky top-0 z-40 bg-white/95 backdrop-blur-md border-b border-stone-200 shadow-sm">
                        <header className="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between gap-2">
                            <button onClick={() => setAppState('setup')} className="p-2 hover:bg-stone-100 rounded-full text-stone-400 active:scale-90"><Icon name="chevron-left" size={24} /></button>
                            <div className="flex items-center gap-2 overflow-x-auto no-scrollbar py-1 flex-1">
                                {samples.map((s, idx) => (<button key={idx} onClick={() => setActiveSampleIndex(idx)} className={`px-5 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all whitespace-nowrap ${activeSampleIndex === idx ? 'bg-stone-800 text-white shadow-lg scale-105' : 'bg-stone-100 text-stone-500 hover:bg-stone-200'}`}>{s.id}</button>))}
                            </div>
                            <button onClick={() => setAppState('report')} className="px-5 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest shadow-xl btn-stone-dark active:scale-95 shrink-0">Report</button>
                        </header>
                        <div className="max-w-6xl mx-auto px-4 md:px-12 pb-4 flex justify-between items-end text-stone-900">
                            <div className="min-w-0 pl-2"><span className="text-stone-300 text-[9px] font-black uppercase tracking-[0.2em] leading-none block mb-1">Eval Sample</span><h2 className="text-base md:text-xl font-black tracking-tight leading-none truncate">{currentSample.lotName || `#${currentSample.id}`}</h2></div>
                            <div className="text-right leading-none shrink-0 pl-4 pr-2"><span className="text-stone-300 text-[9px] font-black uppercase tracking-[0.2em] block mb-1">Live Score</span><span className="text-3xl md:text-4xl font-black tabular-nums">{calculateTotal(currentSample)}</span></div>
                        </div>
                    </div>

                    <main className="max-w-6xl mx-auto p-4 md:p-12 space-y-12 main-container">
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 md:gap-20">
                            <div className="space-y-2 md:space-y-3">
                                <h3 className="text-[10px] font-black text-stone-400 uppercase tracking-[0.3em] mb-4 flex items-center gap-3"><Icon name="clipboard-list" size={14}/> Scoring Attributes</h3>
                                {CATEGORIES.map(cat => (<ScoreControl key={cat.id} label={cat.label} value={currentSample.scores[cat.id]} onUpdate={(d) => updateScore(activeSampleIndex, cat.id, d)} />))}
                                <div className="pt-6 space-y-2 md:space-y-3 border-t-2 border-stone-100 mt-6"><ScoreControl label="Defects" value={currentSample.scores.defects} onUpdate={(d) => updateScore(activeSampleIndex, 'defects', d)} colorClass="text-red-600" /><ScoreControl label="Cup Correction" value={currentSample.scores.correction} onUpdate={(d) => updateScore(activeSampleIndex, 'correction', d)} colorClass="text-blue-600" /></div>
                            </div>
                            <div className="space-y-8">
                                <h3 className="text-[10px] font-black text-stone-400 uppercase tracking-[0.3em] mb-4 flex items-center gap-3"><Icon name="tag" size={14}/> Sensory Lexicon</h3>
                                <LexiconSearch label="Fragrance & Aroma" tags={currentSample.notes.fragAromaTags} options={lexicon.fragAroma} onToggle={(t) => toggleTag(activeSampleIndex, 'fragAroma', t)} onCycle={(t) => cycleTagModifier(activeSampleIndex, 'fragAroma', t)} color="emerald" />
                                <LexiconSearch label="In the Cup" tags={currentSample.notes.inCupTags} options={lexicon.inCup} onToggle={(t) => toggleTag(activeSampleIndex, 'inCup', t)} onCycle={(t) => cycleTagModifier(activeSampleIndex, 'inCup', t)} color="emerald" />
                                <LexiconSearch label="Negative Factors" tags={currentSample.notes.negativeTags} options={lexicon.negative} onToggle={(t) => toggleTag(activeSampleIndex, 'negative', t)} onCycle={(t) => cycleTagModifier(activeSampleIndex, 'negative', t)} color="rose" />
                                <div className="space-y-3 pt-8 border-t-2 border-stone-100"><label className="text-[10px] font-black text-stone-400 uppercase tracking-widest flex items-center gap-2"><Icon name="edit-3" size={12}/> Other Observations</label><textarea value={currentSample.notes.otherText} onChange={(e) => setSamples(prev => { const n = [...prev]; n[activeSampleIndex].notes.otherText = e.target.value; return n; })} className="w-full bg-stone-100 border-2 border-transparent rounded-[1.5rem] p-5 text-sm md:text-base focus:bg-white focus:border-stone-300 min-h-[160px] resize-none transition-all outline-none shadow-inner font-medium text-stone-700 leading-relaxed" placeholder="Specific sensory details..." /></div>
                            </div>
                        </div>
                    </main>
                </div>
            );
        };

        const ScoreControl = ({ label, value, onUpdate, colorClass = "text-stone-900" }) => (
            <div className="flex items-center justify-between bg-white p-3 md:p-5 rounded-2xl border border-stone-200 shadow-sm"><span className="text-sm md:text-lg font-bold text-stone-700 score-label truncate">{label}</span><div className="flex items-center gap-1 md:gap-6 shrink-0 score-control-group"><button onClick={() => onUpdate(-INCREMENT)} className="w-9 h-9 md:w-14 md:h-14 flex items-center justify-center btn-stone-light control-btn shrink-0"><Icon name="minus" size={14} /></button><span className={`text-base md:text-3xl font-black w-12 md:w-20 text-center tabular-nums score-value ${colorClass}`}>{value === null ? 'â€”' : value.toFixed(2)}</span><button onClick={() => onUpdate(INCREMENT)} className="w-9 h-9 md:w-14 md:h-14 flex items-center justify-center btn-stone-light control-btn shrink-0"><Icon name="plus" size={14} /></button></div></div>
        );

        const LexiconSearch = ({ label, tags, options, onToggle, onCycle, color }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const [isFocused, setIsFocused] = useState(false);
            const [smartMatch, setSmartMatch] = useState(null);
            const [isLoading, setIsLoading] = useState(false);
            useEffect(() => {
                const timer = setTimeout(async () => {
                    if (searchTerm.length >= 3 && !options.some(o => o.toLowerCase().includes(searchTerm.toLowerCase()))) {
                        setIsLoading(true);
                        const match = await getSmartMatch(searchTerm, options.filter(o => !tags.some(t => t.endsWith(o))));
                        if (match && match !== "None") setSmartMatch(match);
                        setIsLoading(false);
                    } else { setSmartMatch(null); }
                }, 600);
                return () => clearTimeout(timer);
            }, [searchTerm, options, tags]);
            const filtered = options.filter(o => o.toLowerCase().includes(searchTerm.toLowerCase()) && !tags.some(t => t === o || t === `Slight ${o}` || t === `Intense ${o}`));
            const tagStyles = color === 'rose' ? 'tag-rose' : 'tag-emerald';
            return (
                <div className="space-y-3 relative">
                    <label className="text-[9px] font-black text-stone-400 uppercase tracking-widest block leading-none">{label}</label>
                    <div className="relative">
                        <div className={`flex items-center gap-3 px-4 py-3 rounded-2xl border-2 transition-all shadow-inner ${isFocused ? 'bg-white border-stone-300' : 'bg-stone-50 border-transparent'}`}><Icon name="search" size={16} className="text-stone-300 shrink-0" /><input type="text" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} onFocus={() => setIsFocused(true)} onBlur={() => setTimeout(() => setIsFocused(false), 250)} placeholder="Search notes..." className="bg-transparent border-none p-0 text-sm font-bold text-stone-800 focus:ring-0 w-full placeholder:text-stone-300 outline-none" />{isLoading && <div className="animate-spin text-stone-400 shrink-0"><Icon name="loader-2" size={14} /></div>}</div>
                        {isFocused && searchTerm.length > 0 && (<div className="absolute z-50 left-0 right-0 top-full mt-2 bg-white border-2 border-stone-200 rounded-3xl shadow-2xl overflow-hidden max-h-60 overflow-y-auto p-1">{filtered.slice(0, 8).map(o => (<button key={o} onClick={() => { onToggle(o); setSearchTerm(''); }} className="w-full text-left px-5 py-3.5 text-sm font-bold text-stone-700 hover:bg-stone-50 rounded-xl transition-colors">{o}</button>))}{smartMatch && !filtered.includes(smartMatch) && (<button onClick={() => { onToggle(smartMatch); setSearchTerm(''); }} className="w-full text-left px-5 py-4 bg-stone-900 text-white flex justify-between items-center rounded-xl mt-1"><div className="flex flex-col"><span className="text-[9px] font-black opacity-60 uppercase mb-1 leading-none">Mapping</span><span className="font-black text-base">{smartMatch}</span></div><Icon name="sparkles" size={16} className="text-amber-400" /></button>)}</div>)}
                    </div>
                    <div className="flex flex-wrap gap-2 min-h-[30px]">{tags.map(t => (<span key={t} className={`${tagStyles} px-3 py-1.5 rounded-xl text-[10px] font-black flex items-center gap-2 shadow-sm border active:scale-95`} onClick={() => onCycle(t)}>{t}<button onClick={(e) => { e.stopPropagation(); onToggle(t); }} className="opacity-40 hover:opacity-100 shrink-0"><Icon name="x" size={12} /></button></span>))}</div>
                </div>
            );
        };

        const ReportTags = ({ label, tags, color, alwaysShow = false }) => {
            if (!tags.length && !alwaysShow) return null;
            const s = color === 'rose' ? 'tag-rose' : 'tag-emerald';
            return (
                <div className="space-y-2"><p className="text-[9px] md:text-[10px] font-black text-stone-300 uppercase tracking-widest leading-none block">{label}</p><div className="flex flex-wrap gap-2 min-h-[20px]">{tags.length > 0 ? (tags.map(t => <span key={t} className={`${s} px-2 py-0.5 rounded-lg text-[9px] md:text-[10px] font-black border tracking-tight`}>{t}</span>)) : (<span className="text-[9px] text-stone-300 italic opacity-50">None</span>)}</div></div>
            );
        };

        const SpiderGraph = ({ scores, size, isReport = false }) => {
            const center = size / 2;
            const radius = (size / 2) * 0.72;
            const fragAroma = scores.aroma !== null ? (scores.fragrance + scores.aroma) / 2 : scores.fragrance;
            const data = [fragAroma, scores.cleanCup, scores.sweetness, scores.acidity, scores.body, scores.flavor, scores.aftertaste, scores.balance, scores.consistency, scores.overall];
            const pts = data.map((v, i) => {
                const r = Math.max(0, (v - GRAPH_FLOOR) / (10 - GRAPH_FLOOR)) * radius;
                const angle = i * (Math.PI * 2 / 10) - Math.PI / 2;
                return { x: center + r * Math.cos(angle), y: center + r * Math.sin(angle) };
            });
            const path = pts.map((p, i) => `${i === 0 ? 'M' : 'L'} ${p.x} ${p.y}`).join(' ') + ' Z';
            
            const dynamicScale = isReport ? 'scale-[0.7] sm:scale-100' : 'scale-[0.9] md:scale-100';

            return (
                <div className="w-full flex items-center justify-center overflow-hidden">
                    <svg width={size} height={size} viewBox={`0 0 ${size} ${size}`} className={`overflow-visible font-sans max-w-full h-auto transform ${dynamicScale}`}>
                        {[7.5, 8.5, 9.5].map(v => (<circle key={v} cx={center} cy={center} r={((v - GRAPH_FLOOR) / (10 - GRAPH_FLOOR)) * radius} fill="none" stroke="#e7e5e4" strokeWidth="1" strokeDasharray="4,4" />))}
                        {RADAR_LABELS.map((label, i) => {
                            const angle = i * (Math.PI * 2 / 10) - Math.PI / 2;
                            const x2 = center + radius * Math.cos(angle);
                            const y2 = center + radius * Math.sin(angle);
                            const lp = { x: center + (radius + 24) * Math.cos(angle), y: center + (radius + 24) * Math.sin(angle) };
                            return (<g key={i}><line x1={center} y1={center} x2={x2} y2={y2} stroke="#f5f5f4" strokeWidth="1.5" /><text x={lp.x} y={lp.y} textAnchor="middle" dominantBaseline="middle" className="text-[8px] font-black fill-stone-400 uppercase tracking-tighter">{label}</text></g>);
                        })}
                        <path d={path} fill="rgba(28, 25, 23, 0.12)" stroke="#1c1917" strokeWidth="3" strokeLinejoin="round" />
                        {pts.map((p, i) => <circle key={i} cx={p.x} cy={p.y} r="4.5" fill="#1c1917" stroke="#ffffff" strokeWidth="2.5" />)}
                    </svg>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
